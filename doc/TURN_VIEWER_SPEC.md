# ターン再生ビューワー 機能仕様書

作成目的  
ptcgl形式の試合ログを視覚的に1ターン（先攻・後攻）ごとに再生し、試合の流れを分かりやすく確認できるUIを提供する。

対象ファイル場所  
- doc/logsample/*.txt（解析済みの JSON があれば doc/logsample/parsed/*.json を利用）

要約表示要件（画面に常時表示）
- タイトル／ファイル名
- 現在のターン番号（例: Turn 5）
- プレイヤー表示（先攻 / 後攻 とプレイヤー名）
- 各プレイヤーの残りサイド（Prize数）
- 先攻/後攻どちらのターンかの強調表示
- お互いの「バトル場（アクティブ）」「ベンチ（最大5）」のカード表示（カード名・HP・付いているダメージ/特殊状態/装備アイテム/エネルギーの要約）
- スタジアム・場のカード表示（存在する場合）

再生コントロール
- 次へボタン（Next）: 現在のプレイヤーの「そのターン内の全アクション」をアニメーションで実行し、完了後に停止する。
  - 初期状態は「先攻の Turn N」を表示。Next を押すと「先攻 Turn N のアクション」をアニメーション再生し停止。
  - 次に Next を押すと「後攻 Turn N のアクション」を再生し停止。これで1ターンが完了し次は Turn N+1 の先攻。
- 戻るボタン（Back）: 直前に表示した状態へ巻き戻す（ログ単位の逆アニメーション、もしくは状態スナップショットで復元）。
- 再生（Auto）: Next を自動で連続実行（ユーザー設定で遅延時間を指定）。
- 一時停止（Pause）: 再生中に停止。
- スライダー／ターン選択: 任意のターン・プレイヤー（先攻/後攻）へジャンプ。
- ステップ実行: アクション単位での前進/後進（詳細デバッグ用）。

アニメーション仕様（1アクションの表現）
- カードの移動（デッキ→手札→ベンチ→バトル場→捨て札／Lost Zone／Prize）を視覚化（移動パスと小さいカードアイコン）。
- エネルギー装着: エネルギーアイコンがカードに吸着するアニメーション。
- ダメージ表示: ダメージカウンターが重なる/増えるアニメーション。KO の場合はカードが崩れる／フェードアウト。
- 進化: 元カードの上に新カードが重なり進化ラベルを表示。
- サポート／グッズ使用: 画面上部に操作名と対象を短く表示（例: "Iono を使用 — 両者の手札を下に置く"）。
- 特殊状態: アイコン（Burn/Poison/etc.）をカードにフラグ表示。
- プライズ取得: 右上のプライズ山が1つ減る演出とログ表示。
- スタジアム変化: 画面中央のスタジアム領域を差し替えアニメーション。

データモデル（入力想定）
- parsed JSON（scriptsで生成したスキーマを利用）
  - file: string
  - players: [先攻名, 後攻名]（解析時に順序が逆ならUIで調整）
  - setup: [string]
  - turns: [
      { number: int, player: string, actions: [{ type, raw, ...fields }] }
    ]
  - summary: { turn_count, knockouts, result, ... }
- 各 action.type 候補: draw, play, attach, evolve, attack, knockout, special_condition, prize, pokemon_checkup, result, other
- UI は action.raw をフォールバックとして表示できること

UI構成（主要コンポーネント）
- ヘッダー: ファイル名、ターン、先攻/後攻ラベル、残りサイド数
- 左ペイン: 先攻プレイヤー情報（手札数、手札内容を一覧で表示／非表示切替）
- 右ペイン: 後攻プレイヤー情報（同上）
- 中央ペイン: バトル場ビュー（上下分割: 先攻上 / 後攻下）、スタジアム表示、プライズ表示
- 下部コントロール: Back / Next / Auto / Pause / スライダー / 現在のアクションログ（テキスト）
- モーダル: アクション詳細（raw text を表示）、エラー

ターン遷移ルール
- 1ターンは「先攻の Turn N」と「後攻の Turn N」を合わせた単位とする（表示はプレイヤー単位で交互再生）。
- Next 操作: 現在表示中のプレイヤーの remaining actions を全て順に再生、完了時に UI 状態をそのプレイヤーのターン終了時に固定する。
- Back 操作: 前のプレイヤー（または前のターン末）の状態へ復元。巻き戻しはログに逆順アニメーションを試みるが困難な場合はスナップショット復元。

状態管理
- 各スナップショット: ターン開始時（先攻側）、先攻終了、後攻終了（Turn+1 先攻開始）を保存して高速ジャンプ可能にする。
- アクション適用は差分で実行（カードの追加/削除/属性変更）し、各ステップでスナップショットを撮ることで Back を容易にする。
- 大規模ログ対策: スナップショットは間引き可能（例: 5ターン毎）かオンデマンド生成。

実装技術（推奨）
- フロントエンド: React または Vue（Canvas / DOM ベースどちらでも可。DOM + CSS アニメ推奨でメンテ容易）
- 状態管理: Redux / Pinia 等（スナップショット保持）
- アニメ: CSS トランジション + requestAnimationFrame、または anime.js
- ビルド/ラン: Node.js + vite / webpack。dev container 上で npm run dev を起動。
- JSON パーサ: 既存の parsed/*.json を利用。不足項目は raw 文字列をパースして補う。

ロギング / デバッグ
- アクション単位のログ表示（raw）を常時参照可能にする。
- 不明アクションは「other」としてテキスト表示し、クリックで詳しい raw を確認可能。

アクセシビリティ / UX
- キーボード操作: → / ← で Next / Back。Space で自動再生の一時停止。
- 再生速度調整（スライダー）
- 色覚配慮：ダメージや特殊状態の色はカスタマイズ可能。

起動手順（実装時の仮手順）
1. parsed JSON を配置: doc/logsample/parsed/*.json  
2. フロントエンドを作成（例: web/ フォルダ）  
3. 開発サーバ起動: npm install && npm run dev（dev container 上）  
4. ブラウザで表示: $BROWSER http://localhost:5173 （ポートは環境に合わせる）

出力ファイル（今回作成）
- doc/TURN_VIEWER_SPEC.md（本仕様書）

拡張案（将来的機能）
- カード画像の自動マッピング（カード名→カード画像）
- アクション検索（フィルタ: KO、VSTAR、特定カードの使用）
- 複数ログの比較再生（A/B ウィンドウ）
- 試合のハイライト抽出（重要イベントのみ自動抽出）

制約事項
- ログの曖昧な記述（手札下置き等）は raw テキストを参照して推定表示するが、完全再現は不可。
- Lost Zone / Lost の移動はログが示す限りで扱う。

以上。実装用の最小プロトタイプ設計（ファイル構成案・簡易 React コンポーネント構成）を生成しますか？